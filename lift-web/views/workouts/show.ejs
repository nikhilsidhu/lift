<% layout('layouts/boilerplate') %>

<!-- Workout heading -->
<div class="row mb-4">
    <div class="col-10 offset-1">
      <div class="card">
          <div class="card-body">
            <form class="mb-3" action="/workouts/<%=workout._id%>?_method=PUT" method="POST">
              <input class="d-block mb-1" id="editWorkoutNameInput" type="text" name="workout[workoutName]" value="<%= workout.workoutName %>">
              <button id="editWorkoutNameButton" type="submit"></button>
            </form>
            <h6 class="card-subtitle mb-2 text-muted">Created on <%= temporalDate.convertDate(workout.workoutDate).isoMonth%>-<%= temporalDate.convertDate(workout.workoutDate).isoDay%>-<%= temporalDate.convertDate(workout.workoutDate).isoYear%></h6>
            <p class="card-text">Notes:</p>

            <!-- Buttons -->

            <!-- Back to log -->
            <a href="/workouts" class="m-1 btn btn-primary">Back to Log</a>

            <!-- Edit workout -->
            <a href="/workouts/<%= workout._id%>/edit" class="card-link btn btn-info">Edit Workout</a>
            
            <!-- Delete workout -->
            <form class="d-inline" action="/workouts/<%=workout._id%>?_method=DELETE" method="POST">
                <button class="btn">      
                    <svg class="" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            </form>
          </div>
        </div>
    </div>
</div>

<!-- Add exercise -->
<div class="row">
  <div class="col-10 offset-1">
    <form class="" action="/workouts/<%=workout._id%>/exercises" method="POST">
      <div class="input-group mb-3">
        <input class="form-control" type="text" id="exerciseName" name="exercise[exerciseName]" placeholder="Exercise name">
          <div class="input-group-append">
            <button class="btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
            </button>
          </div>
      </div>
    </form>
  </div>
</div>

<!-- Exercise list -->
<div class="mb-5" id="accordion"> 

  <% let x = 1; %> 
  <% let theExercise %>       

  <% for (let exercise of workout.exercises) { %>
  <% theExercise = exercise %>

  <!-- Exercise item -->
  <div class="row">
    <div class="col-10 offset-1">
      <div class="card exercise-item">
        <div class="card-header d-flex align-items-center" id="headingOne">
          <div class="flex-grow-1">
            <h6 class="mb-0" data-toggle="collapse" data-target="#collapseTable<%=x%>"><%=exercise.exerciseName%></h6>
          </div>
          <div class="ms-auto">
            <form action="/workouts/<%= workout._id %>/exercises/<%= exercise._id %>?_method=DELETE" method="POST">
              <button class="btn btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
              </button>
            </form>

          </div>
        </div>

        <!-- Sets header -->

        <% if (exercise.sets.length) { %>
        <div id="collapseTable<%=x%>" class="collapse-show" aria-labelledby="headingOne" data-parent="#accordion">

        <% } else { %>

        <div id="collapseTable<%=x%>" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">

        <% } %>

          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th class='text-center w-25' scope="col">Set</th>
                <th class='text-center w-25' scope="col">Previous</th>
                <th class='text-center w-25' scope="col">lbs</th>
                <th class='text-center w-25' scope="col">Reps</th>
              </tr>
            </thead>
            <tbody>
              <% let y = 1; %>

              <% for (let set of exercise.sets) { %>

              <!-- List of sets -->
              <tr class="buttonouter">
                <form action="/workouts/<%= workout._id %>/exercises/<%= exercise._id %>/sets/<%= set._id %>?_method=PUT" method="POST">
                  <!-- <td class='text-center w-25'><%= //y %></td>
                  <td class='text-center w-25'></td>
                  <td class='editableWeight text-center w-25' contenteditable="true"><%= //set.weightCompleted %></td>
                  <td class='text-center w-25'><%= //set.repsCompleted %></td> -->

                  <!-- <td class="text-center w-25">
                    <input type="text">
                  </td> -->
                  <td class='text-center w-25'><%= y %></td>
                  <td class='text-center w-25'></td>
                  <td class='text-center w-25'>
                    <input class="editableInput" type="number" name="set[weightCompleted]" value="<%= set.weightCompleted %>">
                  </td>
                  <td class='text-center w-25'>
                    <input class="editableInput" type="number" name="set[repsCompleted]" value="<%= set.repsCompleted %>">
                  </td>
                  <button id="editSetButton" type="submit"></button>
                </form>


                <!-- Delete set -->
                <td class="">
                  <form class="d-inline buttonoverlap" action="/workouts/<%= workout._id %>/exercises/<%= exercise._id %>/sets/<%= set._id %>?_method=DELETE" method="POST">
                    <div class="">
                      <button type="submit" class="btn">      
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                      </button>
                    </div>

                </form>
                </td>
              </tr>
              <% y++; %>
              <% } %>

              <!-- Add set button -->
              <tr class="table-primary">
                <td class="text-center" colspan="100">
                  <button class="btn btn-sm btn-100 w-100" type="button" data-toggle="collapse" data-target="#collapseSetForm<%= x %>" aria-expanded="false" aria-controls="collapseSetForm">
                    + Add Set
                  </button>
                </td>
              </tr>
              
              <% let obj = JSON.stringify(exercise) %>
              <!-- Add set form -->
              <tr id="collapseSetForm<%= x %>" class="collapse">
                <form id="setForm" class="text-center" action="/workouts/<%=workout._id%>/exercises/<%= exercise._id %>/sets" method="POST" data-obj="<%= obj %>">
                  <td class='text-center w-25'><%= y %></td>
                  <td class='text-center w-25'></td>
                  <td class='w-25'>
                    <input id="weightCompleted" class="form-control form-control-sm editableSetInput" type="number" name="set[weightCompleted]">
                  </td>
                  <td class='w-25'>
                    <input id="repsCompleted" class="form-control form-control-sm editableSetInput" type="number" name="set[repsCompleted]">
                  </td>


                  <!-- Submit set form -->
                  <td>
                    <button class="btn" type="submit">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                      </svg>
                   </button>
                  </td>
                </form>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <% x++; %> 
  <% } %>
</div>




<script>

/*   function sendData(exerciseObj) {
    const XHR = new XMLHttpRequest();
  

    let data = new FormData(form);

    XHR.open("POST", `/workouts/<%=//workout._id%>/exercises/${exerciseObj._id}/sets`);
    XHR.send(exerciseObj);

    return false;
  }

  const form = document.getElementById("setForm");
  
  form.addEventListener("submit", function(event) {
    let exerciseObj = JSON.parse(form.getAttribute("data-obj"));
    let exerciseId = exerciseObj._id;
    console.log("HI");
    event.preventDefault();
    sendData(exerciseObj);
  }) */

  // const weights = Array.from(document.getElementsByClassName('editableCell'));

  // weights.forEach(weight => {

  //   weight.addEventListener("keypress", function(e) {
  //     if (e.keyCode === 13) {
  //       e.preventDefault();
  //       document.forms[weight].submit();
  //     }
  //   })

  //   weight.addEventListener("blur", e => {
  //     console.log('Blur event fired!!!');
  //   })
  //  })


</script>